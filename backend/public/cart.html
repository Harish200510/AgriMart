<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Your Cart | Agri Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100">
    <nav
      class="fixed top-0 left-0 w-full bg-green-700 text-white px-6 py-4 flex justify-between"
    >
      <a href="home.html" class="hover:underline">üè† Home</a>
      <span class="font-bold">Shopping Cart</span>
    </nav>

    <div class="mt-24 max-w-3xl mx-auto bg-white shadow-md rounded-2xl p-6">
      <h2 class="text-2xl font-bold mb-4">Your Cart</h2>
      <div id="cartItems" class="divide-y divide-gray-300"></div>
      <div class="flex justify-between items-center mt-6 text-lg font-semibold">
        <span>Total:</span>
        <span class="text-green-600">‚Çπ<span id="totalAmount">0</span></span>
      </div>
      <div class="mt-6 text-center">
        <button
          onclick="checkout()"
          class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700"
        >
          Proceed to Checkout
        </button>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:5000/api";
      const userId = localStorage.getItem("userId");

      if (!userId) {
        alert("Please login first!");
        window.location.href = "login.html";
      }

      async function loadCart() {
        try {
          const res = await fetch(`${API_BASE}/cart/${userId}`);
          const cart = await res.json();
          const container = document.getElementById("cartItems");
          container.innerHTML = "";
          let total = 0;

          if (!cart.items || cart.items.length === 0) {
            container.innerHTML =
              "<p class='text-gray-500'>Your cart is empty.</p>";
            document.getElementById("totalAmount").innerText = 0;
            localStorage.removeItem("cart"); // clear local cart if empty
            return;
          }

          localStorage.setItem("cart", JSON.stringify(cart.items)); // keep local copy

          cart.items.forEach((item) => {
            const prod = item.productId;
            const subtotal = item.quantity * prod.price;
            total += subtotal;
            container.innerHTML += `
            <div class="flex justify-between items-center py-3">
              <div>
                <h3 class="font-semibold">${prod.name}</h3>
                <p>‚Çπ${prod.price} √ó ${item.quantity} = ‚Çπ${subtotal}</p>
              </div>
              <div class="flex items-center gap-2">
                <button onclick="updateQty('${prod._id}', ${
              item.quantity - 1
            })" class="bg-gray-200 px-3 py-1 rounded">‚àí</button>
                <button onclick="updateQty('${prod._id}', ${
              item.quantity + 1
            })" class="bg-gray-200 px-3 py-1 rounded">+</button>
                <button onclick="removeItem('${
                  prod._id
                }')" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-700">Remove</button>
              </div>
            </div>
          `;
          });

          document.getElementById("totalAmount").innerText = total;
        } catch (err) {
          console.error("Error loading cart:", err);
        }
      }

      async function updateQty(productId, newQty) {
        if (newQty <= 0) {
          await removeItem(productId);
          return;
        }
        await fetch(`${API_BASE}/cart/update`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId, productId, quantity: newQty }),
        });
        loadCart();
      }

      async function removeItem(productId) {
        try {
          // backend removal
          await fetch(`${API_BASE}/cart/remove`, {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId, productId }),
          });

          // remove from localStorage
          let cart = JSON.parse(localStorage.getItem("cart")) || [];
          cart = cart.filter((item) => item.productId._id !== productId);
          if (cart.length > 0) {
            localStorage.setItem("cart", JSON.stringify(cart));
          } else {
            localStorage.removeItem("cart");
          }

          loadCart();
        } catch (err) {
          console.error("Error removing item:", err);
        }
      }

      function checkout() {
        const total = document.getElementById("totalAmount").innerText;
        if (parseFloat(total) <= 0) {
          alert("Your cart is empty!");
          return;
        }
        alert("Proceeding to payment gateway...");
        // window.location.href = "payment.html";
      }

      window.onload = loadCart;
    </script>
  </body>
</html>
