<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agriculture Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>

  <body
    class="bg-gray-100"
    style="background-image: url('images/back-home.jpg'); background-attachment: fixed;"
  >
    <!-- Navbar -->
    <nav class="fixed top-0 left-0 w-full z-50 bg-green-700 text-white px-6 py-4 flex items-center justify-between">
      <span class="font-bold text-xl">üå± Agriculture Store</span>

      <!-- Search -->
      <div class="flex-grow mx-6">
        <input
          type="text"
          id="searchInput"
          placeholder="Search products..."
          class="w-full max-w-lg px-4 py-2 rounded-lg text-black focus:outline-none"
        />
      </div>

      <!-- Right side -->
      <div class="flex items-center space-x-4" id="navbarRight"></div>
    </nav>

    <!-- Filters -->
    <div class="fixed top-[64px] left-0 w-full bg-white shadow-md py-4 px-6 z-40">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="flex flex-wrap gap-3">
          <button class="categoryBtn bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700" data-category="all">All</button>
          <button class="categoryBtn bg-gray-200 px-4 py-2 rounded-lg hover:bg-green-100" data-category="vegetables">Vegetables</button>
          <button class="categoryBtn bg-gray-200 px-4 py-2 rounded-lg hover:bg-green-100" data-category="fruits">Fruits</button>
          <button class="categoryBtn bg-gray-200 px-4 py-2 rounded-lg hover:bg-green-100" data-category="plants">Plants</button>
          <button class="categoryBtn bg-gray-200 px-4 py-2 rounded-lg hover:bg-green-100" data-category="seeds">Seeds</button>
          <button class="categoryBtn bg-gray-200 px-4 py-2 rounded-lg hover:bg-green-100" data-category="pesticides">Pesticides</button>
        </div>

        <!-- Price Filter -->
        <div class="flex items-center gap-3">
          <label class="font-medium">Price:</label>
          <input type="number" id="minPrice" placeholder="Min" class="w-20 px-2 py-1 border rounded" />
          <span>-</span>
          <input type="number" id="maxPrice" placeholder="Max" class="w-20 px-2 py-1 border rounded" />
          <button id="applyPriceFilter" class="bg-green-600 text-white px-3 py-1 rounded-lg hover:bg-green-700">Apply</button>
        </div>
      </div>
    </div>

    <!-- Slideshow -->
    <div class="relative w-full max-w-5xl mx-auto mt-44">
      <div class="overflow-hidden rounded-lg shadow-lg">
        <div id="slider" class="flex transition-transform duration-700">
          <div class="flex-shrink-0 w-full"><img src="images/offer.jpg" class="w-full h-64 object-cover" /></div>
          <div class="flex-shrink-0 w-full"><img src="images/offer1.jpg" class="w-full h-64 object-cover" /></div>
          <div class="flex-shrink-0 w-full"><img src="images/offer2.jpg" class="w-full h-64 object-cover" /></div>
        </div>
      </div>
    </div>

    <!-- Product Sections -->
    <div class="max-w-6xl mx-auto px-4 py-8">
      <h2 class="text-2xl font-bold text-green-700 mb-6 text-center">ü•¶ Vegetables</h2>
      <div id="vegetables" class="productGrid grid gap-6 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4"></div>

      <h2 class="text-2xl font-bold text-green-700 mb-6 mt-10 text-center">üçé Fruits</h2>
      <div id="fruits" class="productGrid grid gap-6 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4"></div>

      <h2 class="text-2xl font-bold text-green-700 mb-6 mt-10 text-center">üåø Plants</h2>
      <div id="plants" class="productGrid grid gap-6 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4"></div>

      <h2 class="text-2xl font-bold text-green-700 mb-6 mt-10 text-center">üå± Seeds</h2>
      <div id="seeds" class="productGrid grid gap-6 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4"></div>

      <h2 class="text-2xl font-bold text-green-700 mb-6 mt-10 text-center">üß¥ Pesticides</h2>
      <div id="pesticides" class="productGrid grid gap-6 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4"></div>
    </div>

    <!-- About -->
    <section class="bg-gray-900 text-white py-12 mt-10">
      <div class="max-w-5xl mx-auto px-6 text-center">
        <h2 class="text-3xl font-bold text-green-400 mb-6"><a href="about.html">About Us</a></h2>
        <p class="text-lg leading-relaxed mb-6">
          Welcome to <span class="font-semibold">üå± Agriculture Store</span>, your trusted marketplace for fresh produce, seeds, plants, and farming essentials.
        </p>
      </div>
    </section>

    <script>
      const API_URL = "http://localhost:5000/api/products";
      const CART_URL = "http://localhost:5000/api/cart/add";

      // ---------- Navbar ----------
      function renderNavbar() {
        const username = localStorage.getItem("username");
        const userId = localStorage.getItem("userId");
        const navbar = $("#navbarRight");
        navbar.empty();

        if (username) {
          navbar.append(`
            <button onclick="location.href='sell.html'" class="bg-white text-green-700 px-4 py-2 rounded-lg font-semibold hover:bg-green-100">Sell</button>
            <a href="cart.html" class="relative">
              <img src="images/cart.png" class="w-8 h-8" alt="Cart"/>
              <span id="cartCount" class="absolute -top-2 -right-2 bg-red-500 text-xs text-white px-1 rounded-full">0</span>
            </a>
            <div class="relative">
              <button id="profileBtn">
                <div class="w-10 h-10 flex items-center justify-center rounded-full bg-white text-green-700 font-bold">
                  ${username.charAt(0).toUpperCase()}
                </div>
              </button>
              <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-40 bg-white text-black rounded-lg shadow-lg p-3 z-50">
                <p class="font-semibold">${username}</p>
                <button id="logoutBtn" class="mt-2 w-full bg-red-500 text-white py-1 rounded hover:bg-red-600">Logout</button>
              </div>
            </div>
          `);
        } else {
          navbar.append(`
            <button onclick="window.location.href='login.html'" class="bg-white text-green-700 px-4 py-2 rounded-lg font-semibold hover:bg-green-100">Login</button>
            <button onclick="window.location.href='signup.html'" class="bg-white text-green-700 px-4 py-2 rounded-lg font-semibold hover:bg-green-100">Sign Up</button>
          `);
        }
      }

      $(document).on("click", "#profileBtn", () => $("#profileDropdown").toggle());
      $(document).on("click", "#logoutBtn", () => {
        localStorage.removeItem("username");
        localStorage.removeItem("userId");
        alert("Logged out successfully!");
        window.location.reload();
      });

      // ---------- Cart Handling ----------
      function updateCartCount() {
        const count = JSON.parse(localStorage.getItem("cartCount")) || 0;
        $("#cartCount").text(count);
      }

      async function addToCart(prodId, btn) {
        const username = localStorage.getItem("username");
        const userId = localStorage.getItem("userId");
        if (!username || !userId) {
          alert("‚ö†Ô∏è Please login first!");
          return (window.location.href = "login.html");
        }

        try {
          const res = await fetch(CART_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId, productId: prodId, quantity: 1 }),
          });

          const data = await res.json();
          if (res.ok) {
            // Change button style
            $(btn)
              .removeClass("bg-green-600 hover:bg-green-700 text-white")
              .addClass("bg-green-300 text-black")
              .text("Added");

            // Increment count
            let count = JSON.parse(localStorage.getItem("cartCount")) || 0;
            localStorage.setItem("cartCount", count + 1);
            updateCartCount();

            alert("‚úÖ Item added to cart successfully!");
          } else {
            alert("‚ùå " + data.message);
          }
        } catch (err) {
          console.error("Error adding to cart:", err);
        }
      }

      // ---------- Product Loading ----------
      async function loadProducts() {
        try {
          const res = await fetch(API_URL);
          const products = await res.json();
          document.querySelectorAll(".productGrid").forEach((div) => (div.innerHTML = ""));

          products.forEach((prod) => {
            const container = document.getElementById(prod.category.toLowerCase());
            if (!container) return;

            container.innerHTML += `
              <div class="product bg-white shadow-lg rounded-lg p-4 text-center hover:shadow-xl transition">
                <img src="${prod.image}" class="w-32 h-32 mx-auto rounded-lg object-cover" alt="${prod.name}" />
                <h3 class="mt-3 font-semibold">${prod.name}</h3>
                <p class="text-gray-600">‚Çπ${prod.price}</p>
                <button class="mt-3 w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700"
                  onclick="addToCart('${prod._id}', this)">
                  Add to Cart
                </button>
              </div>`;
          });
        } catch (err) {
          console.error("Error loading products:", err);
        }
      }

      // ---------- Initialize ----------
      $(document).ready(() => {
        renderNavbar();
        loadProducts();
        updateCartCount();
      });
    </script>
  </body>
</html>
